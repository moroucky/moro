<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحميل الفيديوهات (مع التقدم)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; }
        #download-button:disabled { opacity: 0.6; cursor: not-allowed; }
        #status-message { min-height: 1.5rem; transition: color 0.3s ease-in-out; }
        #progress-container { height: 12px; background-color: #718096; border-radius: 6px; }
        .progress-bar {
            transition: width 0.3s ease-in-out;
            background-color: #63b3ed;
            text-align: center;
            color: white;
            font-size: 0.7rem;
            line-height: 12px; /* Match container height */
            white-space: nowrap;
            overflow: hidden;
            border-radius: 6px; /* Match container radius */
        }
        .info-grid span { min-height: 1rem; } /* Reserve space for info text */
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen" style="background-color: #323b4e;">

    <div class="p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg mx-4" style="background-color: #4a5568;">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6" style="color: #e2e8f0;">تحميل الفيديو من الويب</h1>

        <form id="download-form" class="space-y-5">
            <div>
                <label for="video-url" class="block mb-2 text-sm font-medium" style="color: #cbd5e0;">رابط الفيديو:</label>
                <input type="url" id="video-url" name="video_url" placeholder="الصق رابط الفيديو هنا..." required
                       class="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                       style="background-color: #718096; border-color: #a0aec0; color: #e2e8f0;">
            </div>
            <div>
                <label for="format-select" class="block mb-2 text-sm font-medium" style="color: #cbd5e0;">اختر الصيغة:</label>
                <select id="format-select" name="format"
                        class="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 appearance-none bg-no-repeat bg-left-rtl"
                        style="background-color: #718096; border-color: #a0aec0; color: #e2e8f0; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20fill%3D%22none%22%20stroke%3D%22%23cbd5e0%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221.5%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M6%209l6%206%206-6%22%2F%3E%3C%2Fsvg%3E'); background-position: left 0.5rem center;">
                    <option value="best_video" style="background-color: #4a5568; color: #e2e8f0;">أعلى جودة فيديو (MP4)</option>
                    <option value="1080p" style="background-color: #4a5568; color: #e2e8f0;">1080p (MP4)</option>
                    <option value="720p" style="background-color: #4a5568; color: #e2e8f0;">720p (MP4)</option>
                    <option value="480p" style="background-color: #4a5568; color: #e2e8f0;">480p (MP4)</option>
                    <option value="mp3" style="background-color: #4a5568; color: #e2e8f0;">صوت فقط (MP3)</option>
                </select>
                 <p class="mt-1 text-xs" style="color: #a0aec0;">ملاحظة: يتطلب خيار MP3 أو دمج الفيديو وجود 'ffmpeg' في الخادم.</p>
            </div>
            <button type="submit" id="download-button"
                    class="w-full text-white font-bold py-2 px-4 rounded-md focus:outline-none transition duration-150 ease-in-out"
                    style="background-color: #63b3ed; color: #1a202c;">
                بدء التحميل
            </button>
        </form>

        <div id="status-area" class="mt-6 text-center space-y-2">
            <div id="progress-container" class="w-full rounded-full overflow-hidden">
                <div id="progress-bar" class="progress-bar h-full"></div>
            </div>
            <p id="status-message" class="text-sm font-medium"></p>
            <div class="text-xs grid grid-cols-3 gap-2 info-grid" style="color: #cbd5e0;">
                <span id="speed-info">السرعة: -</span>
                <span id="size-info">الحجم: -</span>
                <span id="eta-info">الوقت المتبقي: -</span>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const form = document.getElementById('download-form');
        const urlInput = document.getElementById('video-url');
        const formatSelect = document.getElementById('format-select');
        const downloadButton = document.getElementById('download-button');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const speedInfo = document.getElementById('speed-info');
        const sizeInfo = document.getElementById('size-info');
        const etaInfo = document.getElementById('eta-info');

        let eventSource = null; // Holds the SSE connection
        const API_BASE_URL = 'https://moro-fs49.onrender.com/api'; // Adjust if needed

        // --- UI Reset Function ---
        function resetUI(isError = false) {
            downloadButton.disabled = false;
            downloadButton.textContent = 'بدء التحميل';
            progressBar.style.width = '0%';
            progressBar.textContent = '';
            statusMessage.textContent = isError ? statusMessage.textContent : ''; // Keep error message briefly
            statusMessage.style.color = isError ? '#f56565' : '#a0aec0';
            speedInfo.textContent = 'السرعة: -';
            sizeInfo.textContent = 'الحجم: -';
            etaInfo.textContent = 'الوقت المتبقي: -';
            if (eventSource) {
                eventSource.close(); // Ensure closing previous connection
                eventSource = null;
                console.log("SSE connection closed via resetUI.");
            }
        }

        // --- Update UI based on Task State ---
        function updateUI(taskState) {
            if (!taskState) return; // Safety check

            // Update Progress Bar
            const percentage = taskState.progress?.percentage ?? 0;
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = percentage > 5 ? `${percentage.toFixed(0)}%` : ''; // Integer percentage

            // Update Status Message
            let statusText = '';
            let statusColor = '#cbd5e0'; // Light grey/blue text color
            let isProcessing = false;

            switch (taskState.status) {
                case 'pending': statusText = 'في الانتظار...'; isProcessing = true; break;
                case 'fetching_info': statusText = 'جلب المعلومات...'; isProcessing = true; break;
                case 'preparing_download': statusText = 'تحضير التنزيل...'; isProcessing = true; break;
                case 'downloading':
                    statusText = 'جاري التحميل...';
                    isProcessing = true;
                     // Update Speed, Size, ETA only when downloading
                    speedInfo.textContent = `السرعة: ${taskState.progress?.speed || '-'}`;
                    sizeInfo.textContent = `الحجم: ${taskState.progress?.total_bytes_string || '-'}`;
                    etaInfo.textContent = `الوقت المتبقي: ${taskState.progress?.eta || '-'}`;
                    break;
                case 'postprocessing': statusText = 'جاري المعالجة بعد التحميل...'; isProcessing = true; break;
                case 'finished':
                     statusText = 'اكتمل بنجاح! بدء تنزيل الملف...';
                     statusColor = '#48bb78'; // Green success color
                     isProcessing = false;
                     break;
                case 'error':
                     statusText = `خطأ: ${taskState.error_message || 'حدث خطأ غير معروف.'}`;
                     statusColor = '#f56565'; // Red error color
                     isProcessing = false;
                     break;
                default: statusText = `الحالة: ${taskState.status || 'غير معروف'}`;
            }
            statusMessage.textContent = statusText;
            statusMessage.style.color = statusColor;

            // Update button state based on processing status
            if(isProcessing){
                 downloadButton.disabled = true;
                 downloadButton.textContent = 'قيد المعالجة...';
            }
        }

        // --- Form Submit Handler ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            resetUI(); // Reset UI before new request

            const videoUrl = urlInput.value.trim();
            const selectedFormat = formatSelect.value;

            if (!videoUrl) {
                statusMessage.textContent = 'الرجاء إدخال رابط الفيديو.';
                statusMessage.style.color = '#f56565';
                return;
            }

            // Initial UI state for loading
            downloadButton.disabled = true;
            downloadButton.textContent = 'جاري البدء...';
            statusMessage.textContent = 'بدء الاتصال بالخادم...';
            statusMessage.style.color = '#cbd5e0';
            progressBar.style.width = '0%';

            try {
                // 1. Initiate download
                const initResponse = await fetch(`${API_BASE_URL}/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_url: videoUrl, format: selectedFormat })
                });
                const initData = await initResponse.json();

                if (!initResponse.ok || !initData.success || !initData.task_id) {
                    throw new Error(initData.error || 'فشل في بدء المهمة على الخادم.');
                }
                const taskId = initData.task_id;
                console.log("Task ID:", taskId);

                // 2. Connect to SSE stream
                eventSource = new EventSource(`${API_BASE_URL}/stream/${taskId}`);
                console.log("Connecting to SSE:", eventSource.url);

                eventSource.onopen = () => {
                    console.log("SSE Connection opened.");
                    statusMessage.textContent = 'متصل بالخادم، في انتظار بدء المعالجة...';
                };

                // 3. Handle SSE messages
                eventSource.onmessage = (event) => {
                    try {
                        const taskState = JSON.parse(event.data);
                        updateUI(taskState);

                        if (taskState.status === 'finished') {
                            console.log("Received 'finished' state. URL:", taskState.download_url);
                            if (taskState.download_url) {
                                setTimeout(() => {
                                    window.location.href = taskState.download_url; // Trigger download
                                    // Reset after a longer delay to allow download to start
                                    setTimeout(() => resetUI(), 5000);
                                }, 500); // Short delay before triggering download
                            } else {
                                console.error("Finished state without a download URL!");
                                updateUI({ status: 'error', error_message: 'اكتمل ولكن فشل الحصول على رابط الملف.' });
                            }
                            eventSource.close();
                            console.log("SSE connection closed by client (finished).");
                        } else if (taskState.status === 'error') {
                            console.error("Received 'error' state:", taskState.error_message);
                            updateUI(taskState); // Display the error
                            eventSource.close();
                            console.log("SSE connection closed by client (error).");
                             setTimeout(() => resetUI(true), 5000); // Keep error message longer
                        }
                    } catch (e) {
                        console.error("Error parsing SSE message:", event.data, e);
                        // Avoid closing connection for a single bad message, maybe show temporary parse error
                        statusMessage.textContent = 'خطأ في قراءة تحديث الحالة.';
                        statusMessage.style.color = '#f56565';
                    }
                };

                // 4. Handle SSE connection errors
                eventSource.onerror = (error) => {
                    console.error("SSE Connection Error:", error);
                    statusMessage.textContent = 'انقطع الاتصال بتحديثات الخادم.';
                    statusMessage.style.color = '#f56565';
                    if (eventSource) eventSource.close();
                    eventSource = null;
                    resetUI(true); // Reset with error state
                };

            } catch (error) {
                console.error("Error during initial request:", error);
                statusMessage.textContent = `فشل بدء التحميل: ${error.message}`;
                statusMessage.style.color = '#f56565';
                resetUI(true); // Reset with error state
            }
        });

        // Initialize UI on page load
        resetUI();

    </script>

</body>
</html>
